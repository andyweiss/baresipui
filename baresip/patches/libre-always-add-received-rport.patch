--- a/src/sip/reply.c
+++ b/src/sip/reply.c
@@ -62,14 +62,38 @@
 						   sa_port(&msg->src));
 				rport = true;
 			}
-			else
-				err |= mbuf_write_pl(mb, &hdr->val);
-
-			if (rport || !sa_cmp(&msg->src, &msg->via.addr,
-					     SA_ADDR))
-				err |= mbuf_printf(mb, ";received=%j",
-						   &msg->src);
-
+			else {
+				/* Parse Via header to insert received before branch */
+				const char *branch_start = NULL;
+				size_t pre_branch_len = 0;
+				
+				/* Find ";branch=" in Via header value */
+				for (size_t j = 0; j < hdr->val.l - 7; j++) {
+					if (hdr->val.p[j] == ';' &&
+					    memcmp(&hdr->val.p[j], ";branch=", 8) == 0) {
+						branch_start = &hdr->val.p[j];
+						pre_branch_len = j;
+						break;
+					}
+				}
+				
+				if (branch_start && (true || rport ||
+				    !sa_cmp(&msg->src, &msg->via.addr, SA_ADDR))) {
+					/* Write up to branch */
+					err |= mbuf_write_mem(mb,
+						(const uint8_t *)hdr->val.p, pre_branch_len);
+					/* Insert received before branch */
+					err |= mbuf_printf(mb, ";received=%j",
+						&msg->src);
+					/* Write branch and rest */
+					err |= mbuf_write_mem(mb,
+						(const uint8_t *)branch_start,
+						hdr->val.l - pre_branch_len);
+				} else {
+					/* No branch or no received needed */
+					err |= mbuf_write_pl(mb, &hdr->val);
+				}
+			}
 			err |= mbuf_write_str(mb, "\r\n");
 			break;
 
